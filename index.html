<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FaceOff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ['"inter"', "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body class="font-inter">
    <div class="hidden">
      <input
        id="room_id"
        type="text"
        placeholder="enter a room id to create on/join"
      />
      <button id="join">Join!</button>
      <p id="location">Loading... Move around a bit...</p>
      <p id="bearing"></p>
      <button id="ios_enable" style="display: none">
        Hey, you're on an iOS device! We need you to click this button cuz
        safari is stupid
      </button>
    </div>
    <div class="flex flex-col h-dvh">
      
      <!-- Name -->
      <div class="flex h-1/6 w-full justify-center">
        <h1 class="text-slate-800 text-center place-self-center text-6xl	font-bold	">
          FaceOff
        </h1>
      </div>
      
      <!-- Main menu -->
      <div class="flex flex-col h-2/3 w-full bg-slate-800/25">
        <!-- Instructions -->
        <div class="flex h-1/4 w-full justify-center">
          <h1 class="text-slate-800 text-center text-1xl font-medium">
            Ent
          </h1>
        </div>
      </div>
      
      <!-- Credits -->
      <div class="flex h-1/6 w-full justify-center">
        <h1 class="text-slate-800 text-center place-self-center text-4xl	font-bold	">
          From Kyra With Love &lt;3
        </h1>
      </div>
    </div>
    <script>
      const socket = new WebSocket("wss://face-off.glitch.me/");

      socket.addEventListener("open", (event) => {
        socket.onopen = function (event) {
          console.log("Connected to the WebSocket server");
        };

        document.getElementById("join").addEventListener("click", function () {
          socket.send(
            JSON.stringify({ room: document.getElementById("room_id").value })
          );
          document.getElementById("room_id").value = "";
        });
        function iOS() {
          return (
            [
              "iPad Simulator",
              "iPhone Simulator",
              "iPod Simulator",
              "iPad",
              "iPhone",
              "iPod",
            ].includes(navigator.platform) ||
            // iPad on iOS 13 detection
            (navigator.userAgent.includes("Mac") && "ontouchend" in document)
          );
        }

        if (iOS()) {
          var ios_enable = document.getElementById("ios_enable");
          ios_enable.style = "display:initial";
          ios_enable.addEventListener("click", function () {
            DeviceOrientationEvent.requestPermission()
              .then((response) => {
                ios_enable.style = "display:none";
                if (response === "granted") {
                  window.addEventListener("deviceorientation", direction, true);
                } else {
                  document.getElementById("location").innerHTML =
                    "Hey, you didn't give me permission :<";
                }
              })
              .catch(
                () =>
                  (document.getElementById("location").innerHTML =
                    "Your device sucks lmao")
              );
          });
        } else {
          window.addEventListener("deviceorientation", direction, true);
        }

        const options = {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0,
        };
        navigator.geolocation.getCurrentPosition(coordinates, error, options);
        navigator.geolocation.watchPosition(coordinates, error, options);

        var heading;
        var latitude;
        var longitude;
        var bearing;
        function direction(event) {
          if (event.alpha !== null) {
            heading = event.webkitCompassHeading || Math.abs(event.alpha - 360);
            document.getElementById(
              "location"
            ).innerHTML = `Your heading: ${heading} <br>Your latitude: ${latitude}<br>Your longitude: ${longitude}`;
            socket.send(
              JSON.stringify({
                position: {
                  heading: heading,
                  latitude: latitude,
                  longitude: longitude,
                },
              })
            );
            document.getElementById("bearing").innerHTML = `Bearing: ${
              (bearing - heading + 360) % 360
            }`;
          }
        }
        function coordinates(event) {
          latitude = event.coords.latitude;
          longitude = event.coords.longitude;
          document.getElementById(
            "location"
          ).innerHTML = `Your heading: ${heading} <br>Your latitude: ${latitude}<br>Your longitude: ${longitude}`;
          socket.send(
            JSON.stringify({
              position: {
                heading: heading,
                latitude: latitude,
                longitude: longitude,
              },
            })
          );
        }
        socket.onmessage = function (msg) {
          msg = JSON.parse(msg.data);
          if (msg.bearing) {
            bearing = msg.bearing;
          }
        };
        function error(err) {
          console.log(err);
        }
      });
      socket.addEventListener("close", (event) => {
        alert("Socket connection closed!");
      });
    </script>
  </body>
</html>
