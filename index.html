<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FaceOff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=aspect-ratio"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ['"inter"', "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body class="font-inter">
    <div class="hidden">
      <input
        id="room_id"
        type="text"
        placeholder="enter a room id to create on/join"
      />
      <button id="join">Join!</button>
      <p id="location">Loading... Move around a bit...</p>
      <p id="bearing"></p>
      <button id="ios_enable" style="display: none">
        Hey, you're on an iOS device! We need you to click this button cuz
        safari is stupid
      </button>
    </div>
    <div
      class="flex flex-col h-dvh bg-[url('https://cdn.glitch.global/da55ffba-491b-4656-86d2-8e7c2f4e1ba2/diamond-sunset%20(1).svg?v=1719909882027')]"
    >
      <!-- Name -->
      <div class="flex h-1/6 w-full justify-center">
        <h1
          class="text-slate-200 text-center place-self-center text-6xl font-bold"
        >
          FaceOff
        </h1>
      </div>

      <!-- Main menu -->
      <div class="flex flex-col h-2/3 w-full bg-slate-200/25 justify-center">
        <!-- Code and stuff  -->
        <div class="flex flex-col h-1/2 w-full justify-center gap-3">
          <!-- Code -->
          <div
            class="flex grid grid-cols-4 h-1/2 w-fill mx-3 gap-3 place-items-center"
          >
            <input
              type="text"
              maxlength="1"
              pattern="[a-zA-Z0-9]"
              class="w-full aspect-square text-7xl text-center rounded-lg font-bold uppercase bg-slate-200/50 text-slate-800"
              data-btn="0"
            />
            <input
              type="text"
              maxlength="1"
              pattern="[a-zA-Z0-9]"
              class="w-full aspect-square text-7xl text-center rounded-lg font-bold uppercase bg-slate-200/50 text-slate-800"
              data-btn="1"
            />

            <input
              type="text"
              maxlength="1"
              pattern="[a-zA-Z0-9]"
              class="w-full aspect-square text-7xl text-center rounded-lg font-bold uppercase bg-slate-200/50 text-slate-800"
              data-btn="2"
            />

            <input
              type="text"
              maxlength="1"
              pattern="[a-zA-Z0-9]"
              class="w-full aspect-square text-7xl text-center rounded-lg font-bold uppercase bg-slate-200/50 text-slate-800"
              data-btn="3"
            />
          </div>
          <div
            class="h-1/2 w-full flex flex-row gap-3 px-3 self-center align-center"
          >
            <button
              id="clear_id"
              class="w-1/2 h-full bg-slate-200/25 rounded-lg text-3xl font-medium p-3 hover:bg-slate-200/50 transition ease-in-out duration-300"
              onclick="clearid()"
            >
              Clear
            </button>
            <button
              id="submit_id"
              class="w-1/2 h-full bg-slate-200/25 rounded-lg text-3xl font-medium p-3 hover:bg-slate-200/50 transition ease-in-out duration-300"
              onclick="createRoom()"
            >
              Create Room
            </button>
          </div>
        </div>
      </div>

      <!-- Credits -->
      <div class="flex h-1/6 w-full justify-center">
        <h1
          class="text-slate-200 text-center place-self-center text-4xl font-bold"
        >
          From Kyra With Love &lt;3
        </h1>
      </div>
    </div>
    <script>
      const socket = new WebSocket("wss://face-off.glitch.me/");
      var heading;
      var latitude;
      var longitude;
      var bearing;

      // Functions for initial page
      function clearid() {
        var forms = document.querySelectorAll("[data-btn]");
        for (let i = 0; i < forms.length; i++) {
          forms[i].value = "";
        }
      }
      function createRoom() {
        const letters = "QWERTYUIOPASDFGHJKLZXCVBNM1234567890";
        var forms = document.querySelectorAll("[data-btn]");
        for (let i = 0; i < forms.length; i++) {
          forms[i].value = letters[Math.floor(Math.random() * letters.length)];
        }
        alert("yay");
      }

      document.querySelectorAll("[data-btn]").forEach((element) => {
        element.addEventListener("input", function () {
          const forms = document.querySelectorAll("[data-btn]");
          const code = Array.from(forms)
            .map((element) => element.value)
            .join("");
          if (code.length == 4) {
            document.getElementById("submit_id").innerHTML = "Join Room";
            document.getElementById("submit_id").disabled = false;
          } else if (code.length > 0) {
            document.getElementById("submit_id").innerHTML = "Join Room";
            document.getElementById("submit_id").disabled = true;
          }
        });
        element.addEventListener("keydown", function (event) {
          if (
            event.keyCode === 46 ||
            event.key === "Delete" ||
            event.keyCode === 8 ||
            event.key === "Backspace"
          ) {
            event.preventDefault();
            element.value = "";
            element.previousElementSibling &&
              element.previousElementSibling.focus();

            const elements = document.querySelectorAll("[data-btn]");
            var code = "";

            elements.forEach((element) => {
              code += element.value;
            });
            console.log(code);
            if (code.length == 0) {
              document.getElementById("submit_id").innerHTML = "Create Room";
              document.getElementById("submit_id").disabled = false;
            } else {
              document.getElementById("submit_id").innerHTML = "Join Room";
              document.getElementById("submit_id").disabled = true;
            }
          } else if (event.keyCode === 32 || event.key === "Space") {
            event.preventDefault();
          }
        });
        element.addEventListener("input", function () {
          if (element.value) {
            element.nextElementSibling && element.nextElementSibling.focus();
          }
        });
      });

      socket.addEventListener("open", (event) => {
        socket.onopen = function (event) {
          console.log("Connected to the WebSocket server");
        };

        document.getElementById("join").addEventListener("click", function () {
          socket.send(
            JSON.stringify({ room: document.getElementById("room_id").value })
          );
          document.getElementById("room_id").value = "";
        });
        function iOS() {
          return (
            [
              "iPad Simulator",
              "iPhone Simulator",
              "iPod Simulator",
              "iPad",
              "iPhone",
              "iPod",
            ].includes(navigator.platform) ||
            // iPad on iOS 13 detection
            (navigator.userAgent.includes("Mac") && "ontouchend" in document)
          );
        }

        if (iOS()) {
          var ios_enable = document.getElementById("ios_enable");
          ios_enable.style = "display:initial";
          ios_enable.addEventListener("click", function () {
            DeviceOrientationEvent.requestPermission()
              .then((response) => {
                ios_enable.style = "display:none";
                if (response === "granted") {
                  window.addEventListener("deviceorientation", direction, true);
                } else {
                  document.getElementById("location").innerHTML =
                    "Hey, you didn't give me permission :<";
                }
              })
              .catch(
                () =>
                  (document.getElementById("location").innerHTML =
                    "Your device sucks lmao")
              );
          });
        } else {
          window.addEventListener("deviceorientation", direction, true);
        }

        const options = {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0,
        };
        navigator.geolocation.getCurrentPosition(coordinates, error, options);
        navigator.geolocation.watchPosition(coordinates, error, options);

        function direction(event) {
          if (event.alpha !== null) {
            heading = event.webkitCompassHeading || Math.abs(event.alpha - 360);
            document.getElementById(
              "location"
            ).innerHTML = `Your heading: ${heading} <br>Your latitude: ${latitude}<br>Your longitude: ${longitude}`;
            socket.send(
              JSON.stringify({
                position: {
                  heading: heading,
                  latitude: latitude,
                  longitude: longitude,
                },
              })
            );
            document.getElementById("bearing").innerHTML = `Bearing: ${
              (bearing - heading + 360) % 360
            }`;
          }
        }
        function coordinates(event) {
          latitude = event.coords.latitude;
          longitude = event.coords.longitude;
          document.getElementById(
            "location"
          ).innerHTML = `Your heading: ${heading} <br>Your latitude: ${latitude}<br>Your longitude: ${longitude}`;
          socket.send(
            JSON.stringify({
              position: {
                heading: heading,
                latitude: latitude,
                longitude: longitude,
              },
            })
          );
        }
        socket.onmessage = function (msg) {
          msg = JSON.parse(msg.data);
          if (msg.bearing) {
            bearing = msg.bearing;
          }
        };
        function error(err) {
          console.log(err);
        }
      });
      socket.addEventListener("close", (event) => {
        alert("Socket connection closed!");
      });
    </script>
  </body>
</html>
